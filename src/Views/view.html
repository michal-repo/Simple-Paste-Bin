<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Paste Bin</title>
    <!-- Bootstrap CSS -->
    <link href="libs/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Optional: Add custom CSS here if needed -->
    <style>
        /* Ensure TinyMCE fits well in the modal */
        .tox-tinymce {
            height: 60vh !important;
            /* Adjust as needed */
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        #notes-list .list-group-item {
            cursor: pointer;
        }

        #notes-list .list-group-item:hover {
            background-color: #f8f9fa;
        }

        /* Hide elements initially */
        .show-when-logged-in {
            display: none;
        }

        /* Default hide */
        .show-when-logged-out {
            display: block;
        }

        /* Default show */
        body.logged-in .show-when-logged-in {
            display: block;
        }

        /* Show when body has .logged-in */
        body.logged-in .show-when-logged-out {
            display: none;
        }

        /* Hide when body has .logged-in */

        #note-editor-area {
            display: none;
        }

        /* Hide editor initially */
        #note-attachments-area {
            display: none;
        }

        /* Hide back button initially */
        #back-to-note-btn {
            display: none;
        }

        /* Hide attachments initially */
        #noteModal.editing #note-display-area {
            display: none;
        }

        /* Use correct ID */
        #noteModal.editing #note-editor-area {
            display: block;
        }

        /* Use correct ID */
        #noteModal.editing #note-attachments-area {
            display: none;
        }

        /* Hide delete button when editing */
        #noteModal.editing #delete-note-btn {
            display: none;
        }

        /* Hide attachments when editing */
        #noteModal.editing #edit-note-btn {
            display: none;
        }

        /* Use correct ID */
        #noteModal.editing #save-note-btn {
            display: inline-block;
        }

        /* Use correct ID */
        #noteModal.editing #view-attachments-btn {
            display: none;
        }

        /* Show back button when editing */
        #noteModal.editing #back-to-note-btn {
            display: inline-block;
        }

        /* Hide attachments button when editing */

        #noteModal.viewing-attachments #note-display-area {
            display: none;
        }

        #noteModal.viewing-attachments #note-editor-area {
            display: none;
        }

        #noteModal.viewing-attachments #note-attachments-area {
            display: block;
        }

        #noteModal.viewing-attachments #edit-note-btn,
        #noteModal.viewing-attachments #save-note-btn,
        #noteModal.viewing-attachments #delete-note-btn,
        #noteModal.viewing-attachments #view-attachments-btn {
            display: none;
        }

        /* Hide add attachment button when viewing attachments */
        #noteModal.viewing-attachments #add-attachment-btn {
            display: none;
        }

        /* Show back button when viewing attachments */
        #noteModal.viewing-attachments #back-to-note-btn {
            display: inline-block;
        }

        /* Hide other controls when viewing attachments */
        #noteModal.editing #add-attachment-btn {
            display: none;
        }

        /* Use correct ID */
        #noteModal:not(.editing) #save-note-btn {
            display: none;
        }

        /* Ensure edit/add/delete are shown in default view */
        #noteModal:not(.editing):not(.viewing-attachments) #edit-note-btn,
        #noteModal:not(.editing):not(.viewing-attachments) #add-attachment-btn,
        #noteModal:not(.editing):not(.viewing-attachments) #delete-note-btn {
            display: inline-block;
        }

        #noteModal:not(.editing) #add-attachment-btn {
            display: inline-block;
            /* Show Add Attachment only when viewing note details */
        }


        /* Use correct ID */
    </style>
</head>

<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Simple Paste Bin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- Logged Out Buttons -->
                    <li class="nav-item show-when-logged-out">
                        <button id="login-btn" class="btn btn-outline-primary me-2" data-bs-toggle="modal"
                            data-bs-target="#loginModal">Login</button>
                    </li>
                    <li class="nav-item show-when-logged-out">
                        <button id="register-btn" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#registerModal">Register</button>
                    </li>
                    <!-- Logged In Buttons -->
                    <li class="nav-item show-when-logged-in">
                        <button id="new-note-btn" class="btn btn-success me-2">New Note</button>
                    </li>
                    <li class="nav-item show-when-logged-in">
                        <button id="logout-btn" class="btn btn-outline-secondary">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container mt-4">
        <h2 class="logged-in">My Notes</h2>
        <div id="notes-list" class="list-group show-when-logged-in">
            <!-- Notes will be loaded here -->
            <p>Loading notes...</p>
        </div>
        <div class="show-when-logged-out text-center mt-5">
            <h3>Welcome!</h3>
            <p>Please log in or register to manage your notes.</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div id="login-error" class="text-danger mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="login-form" class="btn btn-primary">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="register-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="register-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-email" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="register-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="register-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="register-password" required>
                        </div>
                        <div id="register-error" class="text-danger mt-2"></div>
                        <div id="register-success" class="text-success mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="register-form" class="btn btn-primary">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Note View/Edit Modal (Fullscreen) -->
    <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="note-modal-title">View Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Area to display note content (read-only) -->
                    <div id="note-display-area">
                        <div id="note-content-display" style="white-space: pre-wrap; word-wrap: break-word;"></div>
                    </div>
                    <!-- Area for TinyMCE editor -->
                    <div id="note-editor-area">
                        <textarea id="note-editor"></textarea>
                    </div>
                    <!-- Area to display attachments -->
                    <div id="note-attachments-area">
                        <h4>Attachments</h4>
                        <ul id="attachment-list" class="list-group"></ul>
                        <div id="attachment-error" class="text-danger mt-2"></div>
                    </div>
                    <div id="note-error" class="text-danger mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="delete-note-btn" class="btn btn-danger me-auto">Delete</button>
                    <!-- Added Delete Button -->
                    <button type="button" id="add-attachment-btn" class="btn btn-success" style="display: none;">Add
                        Attachment</button> <!-- Add Attachment Button -->
                    <button type="button" id="back-to-note-btn" class="btn btn-secondary me-2">Back to
                        Note</button> <!-- Back Button -->
                    <button type="button" id="view-attachments-btn" class="btn btn-info"
                        style="display: none;">Attachments</button> <!-- Attachments Button -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="edit-note-btn" class="btn btn-warning">Edit</button>
                    <button type="button" id="save-note-btn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input for Attachments -->
    <input type="file" id="attachment-file-input" style="display: none;" multiple>

    <!-- Axios -->
    <script src="libs/js/axios.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="libs/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- TinyMCE -->
    <script src="libs/js/tinymce/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        const API_BASE_URL = '/Simple-Paste-Bin/'; // Adjust if your API is hosted elsewhere or has a prefix like /api
        const notesListEl = document.getElementById('notes-list');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const noteModalEl = document.getElementById('noteModal');
        const noteModalInstance = new bootstrap.Modal(noteModalEl);
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteContentDisplay = document.getElementById('note-content-display');
        const editNoteBtn = document.getElementById('edit-note-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const backToNoteBtn = document.getElementById('back-to-note-btn'); // Back button reference
        const viewAttachmentsBtn = document.getElementById('view-attachments-btn'); // Attachments button reference
        const addAttachmentBtn = document.getElementById('add-attachment-btn'); // Add Attachment button reference
        const attachmentFileInput = document.getElementById('attachment-file-input'); // File input reference
        const noteAttachmentsArea = document.getElementById('note-attachments-area');
        const attachmentListEl = document.getElementById('attachment-list');
        const attachmentErrorEl = document.getElementById('attachment-error');
        const loginModalInstance = new bootstrap.Modal(document.getElementById('loginModal'));
        // const registerModalInstance = new bootstrap.Modal(document.getElementById('registerModal'));

        let authToken = localStorage.getItem('authToken');
        let currentNoteId = null;
        let currentNoteTitle = "";
        let notesCache = []; // Simple cache for notes

        // --- Axios Instance ---
        const apiClient = axios.create({
            baseURL: API_BASE_URL,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });

        // Add a request interceptor to include the token
        apiClient.interceptors.request.use(config => {
            if (authToken) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        // --- UI Update ---
        function updateUI() {
            if (authToken) {
                document.body.classList.add('logged-in');
                document.body.classList.remove('logged-out');
                fetchNotes();
            } else {
                document.body.classList.remove('logged-in');
                document.body.classList.add('logged-out');
                notesListEl.innerHTML = '<p class="text-muted text-center">Log in to see your notes.</p>';
            }
        }

        // --- TinyMCE ---
        function initTinyMCE(content = '') {
            tinymce.init({
                selector: '#note-editor',
                plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons accordion',
                menubar: 'file edit view insert format tools table help',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | align numlist bullist | link image | table media | lineheight outdent indent| forecolor backcolor removeformat | charmap emoticons | code fullscreen preview | save print | pagebreak anchor codesample | ltr rtl',
                autosave_ask_before_unload: true,
                autosave_interval: '30s',
                autosave_prefix: '{path}{query}-{id}-',
                autosave_restore_when_empty: false,
                autosave_retention: '2m',
                license_key: 'gpl',
                height: 'calc(100vh - 200px)', // Adjust height to fit modal
                setup: function (editor) {
                    editor.on('init', function () {
                        editor.setContent(content);
                    });
                }
            });
        }

        function destroyTinyMCE() {
            const editor = tinymce.get('note-editor');
            if (editor) {
                editor.destroy();
            }
        }

        // --- API Calls ---
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                const response = await apiClient.post('/log-in', { email, password });
                authToken = response.data.data.token;
                localStorage.setItem('authToken', authToken);
                loginModalInstance.hide();
                loginForm.reset();
                updateUI();
            } catch (error) {
                console.error("Login failed:", error.response?.data || error.message);
                errorEl.textContent = error.response?.data?.status?.message || 'Login failed. Please check your credentials.';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const successEl = document.getElementById('register-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            try {
                await apiClient.post('/register', { username, email, password });
                successEl.textContent = 'Registration successful! You can now log in.';
                registerForm.reset();
                // Optionally close modal after a delay or keep open
                // setTimeout(() => registerModalInstance.hide(), 2000);
            } catch (error) {
                console.error("Registration failed:", error.response?.data || error.message);
                errorEl.textContent = error.response?.data?.status?.message || 'Registration failed. Please try again.';
            }
        }

        function handleLogout() {
            // No API call needed for simple JWT logout, just clear client side
            authToken = null;
            localStorage.removeItem('authToken');
            notesCache = []; // Clear cache on logout
            updateUI();
        }

        async function fetchNotes() {
            if (!authToken) return;
            try {
                const response = await apiClient.get('/notes');
                notesCache = response.data.data || [];
                renderNotesList();
            } catch (error) {
                console.error("Failed to fetch notes:", error.response?.data || error.message);
                if (error.response?.status === 401) { // Token expired or invalid
                    handleLogout();
                } else {
                    notesListEl.innerHTML = '<p class="text-danger">Could not load notes.</p>';
                }
            }
        }

        function renderNotesList() {
            if (!notesCache.length) {
                notesListEl.innerHTML = '<p class="text-muted">No notes found. Create one!</p>';
                return;
            }
            notesListEl.innerHTML = ''; // Clear previous list
            notesCache.forEach(note => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                // Display a snippet or title if available, otherwise part of the note
                const preview = note.note.substring(0, 100) + (note.note.length > 100 ? '...' : '');
                item.innerHTML = `<strong>${note.note_title}</strong><br>${preview.replace(/<[^>]*>?/gm, '')}`; // Basic preview, strip HTML
                item.dataset.noteId = note.id;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    viewNote(note.id);
                });
                notesListEl.appendChild(item);
            });
        }

        // --- Reusable Attachment UI Update ---
        async function fetchAndUpdateAttachmentsUI(noteId) {
            if (!noteId) return; // Safety check

            viewAttachmentsBtn.style.display = 'none'; // Hide initially
            viewAttachmentsBtn.onclick = null; // Clear previous listener

            try {
                const response = await apiClient.get(`/notes/${noteId}/attachments`);
                const attachments = response.data.data || [];
                if (attachments.length > 0) {
                    viewAttachmentsBtn.style.display = 'inline-block'; // Show button if attachments exist
                    viewAttachmentsBtn.onclick = () => showAttachmentsView(attachments); // Update listener with new data
                    // If currently viewing attachments, refresh the list immediately
                    if (noteModalEl.classList.contains('viewing-attachments')) {
                        showAttachmentsView(attachments);
                    }
                }
                // No need for an else block, button is already hidden and listener cleared
            } catch (fetchError) {
                console.error("Failed to fetch/update attachments UI:", fetchError.response?.data || fetchError.message);
                // Let the calling function decide how to display the error
                throw fetchError; // Re-throw the error to be caught by the caller
            }
        }
        async function viewNote(noteId) {
            const note = notesCache.find(n => n.id === noteId);
            if (!note) return;

            currentNoteId = note.id;
            currentNoteTitle = note.note_title;
            noteModalTitle.textContent = `Note ${note.note_title}`;
            noteContentDisplay.innerHTML = note.note; // Display raw HTML content
            noteModalEl.classList.remove('editing', 'viewing-attachments'); // Reset state to default view
            attachmentListEl.innerHTML = ''; // Clear previous attachments
            attachmentErrorEl.textContent = ''; // Clear errors
            addAttachmentBtn.style.display = 'inline-block'; // Show add attachment button
            deleteNoteBtn.style.display = 'inline-block'; // Show delete button when viewing existing note

            // Fetch attachments for this note
            try {
                await fetchAndUpdateAttachmentsUI(currentNoteId);
            } catch (error) {
                attachmentErrorEl.textContent = 'Could not load attachments.';
                // The reusable function already logged the detailed error
                viewAttachmentsBtn.onclick = null; // Remove listener on error
                if (error.response?.status === 401) {
                    handleLogout();
                }
            }

            noteModalInstance.show();
        }

        function showAttachmentsView(attachments) {
            noteModalEl.classList.remove('editing');
            noteModalEl.classList.add('viewing-attachments');
            attachmentListEl.innerHTML = ''; // Clear previous list
            attachments.forEach(att => {
                if (!currentNoteId) return; // Should not happen, but safety first

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center'; // Use flexbox for layout
                li.dataset.attachmentId = att.id; // Store ID for deletion

                // Use a span or button-like element for the download trigger
                const link = document.createElement('a');
                link.href = '#'; // Prevent navigation
                link.textContent = att.file_name || `Attachment ${att.id}`;
                link.style.cursor = 'pointer'; // Indicate it's clickable
                link.onclick = (e) => {
                    e.preventDefault(); // Prevent default anchor behavior
                    downloadAttachment(att.id, att.file_name || `attachment_${att.id}`);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteAttachment(currentNoteId, att.id); // Pass noteId and attachmentId
                li.appendChild(link);
                // Optionally add delete button per attachment here if needed later
                attachmentListEl.appendChild(li);
                li.appendChild(deleteBtn); // Add the delete button
                attachmentListEl.appendChild(li);
            });
        }

        function openNewNoteEditor() {
            currentNoteId = null; // Indicate new note
            noteModalTitle.textContent = 'Create New Note';
            noteModalEl.classList.remove('viewing-attachments');
            noteModalEl.classList.add('editing');
            deleteNoteBtn.style.display = 'none'; // Hide delete button for new notes
            addAttachmentBtn.style.display = 'none'; // Hide add attachment button for new notes
            viewAttachmentsBtn.style.display = 'none'; // Hide attachments button for new notes
            initTinyMCE(''); // Initialize with empty content
            noteModalInstance.show();
        }

        function switchToEditMode() {
            if (!currentNoteId) return; // Should not happen if button is clicked correctly
            const note = notesCache.find(n => n.id === currentNoteId);
            if (!note) return;

            noteModalTitle.textContent = `Edit Note ${note.note_title}`;
            noteModalEl.classList.remove('viewing-attachments'); // Ensure not viewing attachments
            addAttachmentBtn.style.display = 'none'; // Hide add attachment button when editing
            noteModalEl.classList.add('editing');
            initTinyMCE(note.note); // Initialize with current note content
        }

        async function saveNote() {
            const content = tinymce.get('note-editor').getContent();
            const errorEl = document.getElementById('note-error');
            errorEl.textContent = '';
            let url = '/notes';
            let method = 'post';

            if (currentNoteId) { // Update existing note
                url = `/notes/${currentNoteId}`;
                method = 'put';
            }

            try {
                await apiClient[method](url, { note: content });
                destroyTinyMCE();
                noteModalInstance.hide();
                fetchNotes(); // Refresh list
            } catch (error) {
                console.error("Failed to save note:", error.response?.data || error.message);
                errorEl.textContent = error.response?.data?.status?.message || 'Failed to save note.';
                if (error.response?.status === 401) {
                    handleLogout(); // Log out if unauthorized
                }
            }
        }

        async function deleteNote() {
            if (!currentNoteId || !confirm('Are you sure you want to delete this note?')) {
                return;
            }
            const errorEl = document.getElementById('note-error');
            errorEl.textContent = '';

            try {
                await apiClient.delete(`/notes/${currentNoteId}`);
                noteModalInstance.hide();
                fetchNotes(); // Refresh list
            } catch (error) {
                console.error("Failed to delete note:", error.response?.data || error.message);
                // Show error inside modal before it closes, or use a global alert system
                alert(error.response?.data?.status?.message || 'Failed to delete note.');
                if (error.response?.status === 401) {
                    handleLogout(); // Log out if unauthorized
                }
            }
        }

        async function deleteAttachment(noteId, attachmentId) {
            if (!noteId || !attachmentId || !confirm('Are you sure you want to delete this attachment?')) {
                return;
            }

            attachmentErrorEl.textContent = ''; // Clear previous errors

            try {
                await apiClient.delete(`/notes/${noteId}/attachments/${attachmentId}`);

                // Remove the item from the list visually
                const itemToRemove = attachmentListEl.querySelector(`li[data-attachment-id="${attachmentId}"]`);
                if (itemToRemove) {
                    itemToRemove.remove();
                }

                // Refresh the attachment list state (e.g., hide "Attachments" button if none left)
                await fetchAndUpdateAttachmentsUI(noteId);

            } catch (error) {
                console.error("Failed to delete attachment:", error.response?.data || error.message);
                attachmentErrorEl.textContent = error.response?.data?.status?.message || 'Failed to delete attachment.';
                if (error.response?.status === 401) {
                    handleLogout(); // Log out if unauthorized
                }
            }
        }

        // --- Function to handle authenticated download ---
        async function downloadAttachment(attachmentId, fileName) {
            attachmentErrorEl.textContent = 'Downloading...'; // Provide feedback
            try {
                const response = await apiClient.get(`/attachments/download/${attachmentId}`, {
                    responseType: 'blob' // Important: Expect binary data
                });

                // Create a Blob link and trigger download
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', fileName); // Use the provided filename
                document.body.appendChild(link);
                link.click();

                // Clean up
                link.parentNode.removeChild(link);
                window.URL.revokeObjectURL(url);
                attachmentErrorEl.textContent = ''; // Clear feedback

            } catch (error) {
                console.error("Failed to download attachment:", error.response?.data || error.message);
                attachmentErrorEl.textContent = 'Failed to download attachment.';
                if (error.response?.status === 401) {
                    handleLogout(); // Log out if unauthorized
                }
            }
        }

        // --- Switch back to Note View ---
        function switchToViewMode() {
            destroyTinyMCE(); // Destroy editor if it exists
            noteModalEl.classList.remove('editing', 'viewing-attachments'); // Remove state classes
            noteModalTitle.textContent = `Note ${currentNoteTitle}`; // Reset title
            // CSS rules will handle showing/hiding the correct areas and buttons
            // Re-fetch attachments UI state in case attachments were added/deleted
            if (currentNoteId) {
                fetchAndUpdateAttachmentsUI(currentNoteId).catch(err => console.error("Error updating attachments UI on switch to view", err));
            }
        }

        // --- Attachment Handling ---
        function handleAddAttachmentClick() {
            if (!currentNoteId) {
                console.error("Cannot add attachment: No note selected.");
                return;
            }
            // Trigger the hidden file input
            attachmentFileInput.click();
        }

        async function handleFileUpload(event) {
            if (!currentNoteId) return; // Should have a note ID

            const files = event.target.files;
            if (!files.length) return; // No files selected

            const formData = new FormData();
            for (const file of files) {
                formData.append('attachment_file', file); // Use 'attachment_file' as the key
            }

            // Show some loading indicator if desired
            attachmentErrorEl.textContent = 'Uploading...';

            try {
                await apiClient.post(`/notes/${currentNoteId}/attachments`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data' // Axios sets this automatically for FormData, but good to be aware
                    }
                });

                attachmentErrorEl.textContent = ''; // Clear status/error
                // alert('Attachment(s) uploaded successfully!');

                // --- Refetch attachments and update UI using the reusable function ---
                try {
                    await fetchAndUpdateAttachmentsUI(currentNoteId);
                } catch (fetchError) {
                    // Error already logged by fetchAndUpdateAttachmentsUI
                    attachmentErrorEl.textContent = 'Upload successful, but failed to refresh attachment list.';
                }
                // --- End Refetch ---

            } catch (error) {
                console.error("Failed to upload attachment:", error.response?.data || error.message);
                attachmentErrorEl.textContent = error.response?.data?.status?.message || 'Failed to upload attachment(s).';
            } finally {
                // Reset file input so the change event fires again if the same file is selected
                event.target.value = null;
            }
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        newNoteBtn.addEventListener('click', openNewNoteEditor);
        editNoteBtn.addEventListener('click', switchToEditMode);
        saveNoteBtn.addEventListener('click', saveNote);
        deleteNoteBtn.addEventListener('click', deleteNote);
        backToNoteBtn.addEventListener('click', switchToViewMode); // Listener for the new button
        addAttachmentBtn.addEventListener('click', handleAddAttachmentClick);
        attachmentFileInput.addEventListener('change', handleFileUpload);
        // The click listener for viewAttachmentsBtn is set dynamically in viewNote

        // Cleanup TinyMCE when modal is hidden
        noteModalEl.addEventListener('hidden.bs.modal', () => {
            // destroyTinyMCE();
            noteModalEl.classList.remove('viewing-attachments'); // Reset attachment view state
            viewAttachmentsBtn.style.display = 'none'; // Hide attachments button
            addAttachmentBtn.style.display = 'none'; // Hide add attachment button
            noteModalEl.classList.remove('editing'); // Reset editing state
            document.getElementById('note-error').textContent = ''; // Clear errors
        });

        // --- Initial Load ---
        updateUI();

    </script>

</body>

</html>